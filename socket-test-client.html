<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Test Client</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .message { background-color: #d1ecf1; color: #0c5460; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Socket.IO Chat Test Client</h1>
        <p><strong>Instructions:</strong> 
        <br>‚Ä¢ <strong>Option 1:</strong> Enter User ID and Destination User ID, then generate a Room ID
        <br>‚Ä¢ <strong>Option 2:</strong> Enter any Room ID directly (e.g., "my-room", "test-123")
        <br>‚Ä¢ Connect to the server and test the chat functionality
        </p>
        
        <div id="status" class="status disconnected">Disconnected</div>
        
        <div>
            <label for="serverUrl">Server URL:</label>
            <input type="text" id="serverUrl" value="http://localhost:8080" style="width: 300px;">
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()" id="disconnectBtn" disabled>Disconnect</button>
        </div>
        
        <div>
            <label for="userId">User ID (optional):</label>
            <input type="text" id="userId" placeholder="Leave empty for anonymous">
        </div>
        
        <div>
            <label for="destinationId">Destination User ID:</label>
            <input type="text" id="destinationId" placeholder="Enter destination user ID">
        </div>
        
        <div>
            <label for="roomId">Room ID:</label>
            <input type="text" id="roomId" placeholder="Enter room ID or generate from user IDs" style="width: 300px;">
            <button onclick="generateRoomId()" style="margin-left: 10px;">Generate</button>
        </div>
        
        <div>
            <button onclick="testConnection()">Test Connection</button>
            <button onclick="joinRoom()">Join Room</button>
            <button onclick="sendMessage()">Send Message</button>
        </div>
        
        <div>
            <label for="message">Test Message:</label>
            <input type="text" id="message" value="Hello from external client!" style="width: 300px;">
        </div>
        
        <div style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
            <h4>Current State:</h4>
            <div id="chatState">
                <p><strong>User ID:</strong> <span id="currentUserId">Not set</span></p>
                <p><strong>Destination ID:</strong> <span id="currentDestinationId">Not set</span></p>
                <p><strong>Room ID:</strong> <span id="currentRoomId">Not set</span></p>
                <p><strong>Connected:</strong> <span id="currentConnection">No</span></p>
            </div>
        </div>
        
        <h3>Connection Log:</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        let socket = null;
        let isConnected = false;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                statusDiv.textContent = 'Connected';
                statusDiv.className = 'status connected';
                disconnectBtn.disabled = false;
            } else {
                statusDiv.textContent = 'Disconnected';
                statusDiv.className = 'status disconnected';
                disconnectBtn.disabled = true;
            }
            
            updateChatState();
        }

        function updateChatState() {
            const userId = document.getElementById('userId').value || 'Not set';
            const destinationId = document.getElementById('destinationId').value || 'Not set';
            const roomId = document.getElementById('roomId').value || 'Not set';
            const connected = isConnected ? 'Yes' : 'No';
            
            document.getElementById('currentUserId').textContent = userId;
            document.getElementById('currentDestinationId').textContent = destinationId;
            document.getElementById('currentRoomId').textContent = roomId;
            document.getElementById('currentConnection').textContent = connected;
        }

        function connect() {
            const serverUrl = document.getElementById('serverUrl').value;
            const userId = document.getElementById('userId').value;
            
            if (socket) {
                socket.disconnect();
            }
            
            log(`Connecting to ${serverUrl}...`);
            
            // Configure socket with proper options for external connections
            socket = io(serverUrl, {
                transports: ['websocket', 'polling'],
                upgrade: true,
                rememberUpgrade: false,
                timeout: 20000,
                forceNew: true,
                query: userId ? { user: userId } : {}
            });

            socket.on('connect', () => {
                isConnected = true;
                updateStatus(true);
                log(`‚úÖ Connected! Socket ID: ${socket.id}`);
            });

            socket.on('disconnect', (reason) => {
                isConnected = false;
                updateStatus(false);
                log(`‚ùå Disconnected: ${reason}`);
            });

            socket.on('connect_error', (error) => {
                log(`‚ùå Connection error: ${error.message}`);
            });

            socket.on('connection', (data) => {
                log(`üì® Connection message: ${JSON.stringify(data)}`);
            });

            socket.on('chat_message', (data) => {
                log(`üí¨ Chat message: ${JSON.stringify(data)}`);
            });

            socket.on('room_joined', (data) => {
                log(`üö™ Room joined: ${JSON.stringify(data)}`);
            });

            socket.on('user_joined_room', (data) => {
                log(`üë§ User joined room: ${JSON.stringify(data)}`);
            });

            socket.on('user_joined_chat', (data) => {
                log(`üë§ User joined chat: ${JSON.stringify(data)}`);
            });

            socket.on('connection_test', (data) => {
                log(`üß™ Connection test: ${JSON.stringify(data)}`);
            });

            socket.on('error', (error) => {
                log(`‚ùå Socket error: ${JSON.stringify(error)}`);
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                isConnected = false;
                updateStatus(false);
                log('Disconnected manually');
            }
        }

        function testConnection() {
            if (socket && isConnected) {
                socket.emit('test_connection', { message: 'Testing connection from external client' });
                log('Sent connection test');
            } else {
                log('‚ùå Not connected');
            }
        }

        function generateRoomId() {
            const userId = document.getElementById('userId').value;
            const destinationId = document.getElementById('destinationId').value;
            
            if (!userId || !destinationId) {
                log('‚ùå Please enter both User ID and Destination ID');
                return;
            }
            
            // Simple room ID generation (similar to backend logic)
            const sortedStrings = [userId, destinationId].sort();
            const combined = sortedStrings.join("|");
            
            // Simple hash function for demo
            let hash = 0;
            for (let i = 0; i < combined.length; i++) {
                const char = combined.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            const roomId = Math.abs(hash).toString(16).substring(0, 8);
            
            document.getElementById('roomId').value = roomId;
            updateChatState();
            log(`Generated Room ID: ${roomId} for users ${userId} and ${destinationId}`);
        }

        function joinRoom() {
            if (socket && isConnected) {
                const roomId = document.getElementById('roomId').value;
                
                if (!roomId.trim()) {
                    log('‚ùå Please enter a Room ID first');
                    return;
                }
                
                // Try join_chat first (for chat rooms with database)
                socket.emit('join_chat', {
                    chatID: roomId
                });
                log(`Attempting to join room: ${roomId}`);
            } else {
                log('‚ùå Not connected');
            }
        }

        function sendMessage() {
            if (socket && isConnected) {
                const message = document.getElementById('message').value;
                const roomId = document.getElementById('roomId').value;
                const userId = document.getElementById('userId').value;
                
                if (!roomId.trim()) {
                    log('‚ùå Please enter a Room ID first');
                    return;
                }
                
                if (!message.trim()) {
                    log('‚ùå Please enter a message');
                    return;
                }
                
                socket.emit('send_chat_message', {
                    chatID: roomId,
                    message: message,
                    userID: userId || `anonymous_${socket.id}`
                });
                log(`Sent message to room ${roomId}: ${message}`);
            } else {
                log('‚ùå Not connected');
            }
        }

        // Auto-connect on page load
        window.onload = function() {
            log('Socket.IO Test Client loaded');
            log('Click Connect to test the connection');
            
            // Add event listeners to update chat state when inputs change
            document.getElementById('userId').addEventListener('input', updateChatState);
            document.getElementById('destinationId').addEventListener('input', updateChatState);
            document.getElementById('roomId').addEventListener('input', updateChatState);
            
            // Initial state update
            updateChatState();
        };
    </script>
</body>
</html>
